angular.module("dibari.angular-ellipsis",[]).directive("ellipsis",["$timeout","$window","$sce",function(a,b,c){var d=function(b){var c=null,d=[];this.remove=function(b){-1!==d.indexOf(b)&&(d.splice(d.indexOf(b),1),0===d.length&&(a.cancel(c),c=null))},this.add=function(e){-1===d.indexOf(e)&&d.push(e),c||(c=a(function(){var a=d.slice();c=null,d.length=0,a.forEach(function(a){a()})},b))}},e=new d(0),f=new d(250);return{restrict:"A",scope:{ngShow:"=",ngBind:"=",ngBindHtml:"=",ellipsisAppend:"@",ellipsisAppendClick:"&",ellipsisSymbol:"@",ellipsisSeparator:"@",useParent:"@",ellipsisUseParent:"@",ellipsisSeparatorReg:"=",ellipsisMaxLines:"@",ellipsisDefaultFontSize:"@",ellipsisFallbackFontSize:"@"},compile:function(a,d,g){return function(a,d,g){function h(a){return"undefined"!=typeof a}function i(a){var b=0;return angular.forEach(a.parent().children(),function(c){c!=a[0]&&(b+=c.clientHeight)}),a.parent()[0].clientHeight-b}function j(){var b=a.ngBind||a.ngBindHtml,e=!1;if(c.isEnabled()&&angular.isObject(b)&&c.getTrustedHtml(b)&&(e=!0,b=c.getTrustedHtml(b)),b){h(a.ellipsisDefaultFontSize)&&d.css("font-size",a.ellipsisDefaultFontSize);var f=!a.ngBind&&!!a.ngBindHtml,j=g.ellipsisUseParent||g.useParent,n=g.ellipsisMaxLines,o="undefined"!=typeof g.ellipsisSymbol?g.ellipsisSymbol:"&hellip;",p="undefined"!=typeof g.ellipsisSeparator?g.ellipsisSeparator:" ",q="undefined"!=typeof g.ellipsisSeparatorReg?g.ellipsisSeparatorReg:new RegExp("["+p+"]+","gm"),r="undefined"!=typeof g.ellipsisAppend&&""!==g.ellipsisAppend?o+"<span class='angular-ellipsis-append'>"+g.ellipsisAppend+"</span>":o;if(f?d.html(b):d.text(b),h(a.ellipsisFallbackFontSize)&&m(d,j)&&d.css("font-size",a.ellipsisFallbackFontSize),n){var s=d[0].style.display;d[0].style.display="inline";var t=d[0].getBoundingClientRect(),u=d[0].getClientRects(),v=Math.ceil(t.height/u.length);d[0].style.display=s,d[0].style.maxHeight=v*a.ellipsisMaxLines+"px"}if(m(d,j)){d.attr("data-overflowed","true");for(var w=j?i(d):d[0].clientHeight,x=[];null!==(match=q.exec(b));)x.push(match.index);if(0===x.length){for(var y=5;y<=b.length;)x.push(y),y=2*y;x.push(b.length)}for(var z,A=0,B=x.length-1;;){z=A+(B-A>>1);var C=l(d,k(b,x,z)+r,w);if(B-A===1)break;C?B=z:A=z}g.isTruncated=!0,f?d.html(k(b,x,z)+r):d.text(k(b,x,z)).html(d.html()+r),o!=r&&"undefined"!=typeof a.ellipsisAppendClick&&""!==a.ellipsisAppendClick&&d.find("span.angular-ellipsis-append").bind("click",function(b){a.$apply(function(){a.ellipsisAppendClick.call(a,{event:b})})}),!e&&c.isEnabled()&&c.trustAsHtml(b)}else d.attr("data-overflowed","false")}}function k(a,b,c){return a.substr(0,b[c])}function l(a,b,c){return a[0].innerHTML=b,a[0].scrollHeight>c}function m(a,b){return a=b?a.parent():a,a[0].scrollHeight>a[0].clientHeight}function n(){(g.lastWindowResizeWidth!=window.innerWidth||g.lastWindowResizeHeight!=window.innerHeight)&&j(),g.lastWindowResizeWidth=window.innerWidth,g.lastWindowResizeHeight=window.innerHeight}function o(){f.add(n)}g.lastWindowResizeTime=0,g.lastWindowResizeWidth=0,g.lastWindowResizeHeight=0,g.lastWindowTimeoutEvent=null,g.isTruncated=!1,a.$watch("ngShow",function(){e.add(j)}),a.$watch("ngBind",function(){e.add(j)}),a.$watch("ngBindHtml",function(){e.add(j)}),a.$watch("ellipsisAppend",function(){j()}),a.$watch(function(){return 0!==d[0].offsetWidth&&0!==d[0].offsetHeight},function(){f.add(j)});var p=a.$on("dibari:refresh-ellipsis",function(){e.add(j)}),q=angular.element(b);q.bind("resize",o),a.$on("$destroy",function(){q.unbind("resize",o),e.remove(j),f.remove(n),p&&(p(),p=null)})}}}}]);